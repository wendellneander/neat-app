<html>
  <head>
    <base href="." />
    <meta charset="UTF-8" />
    <title>NEAT Algorithm Visualization</title>
    <style>
      :root {
        --bg-color: #1a1a1a;
        --text-color: #ffffff;
        --node-color: #4caf50;
        --connection-color: #2196f3;
        --disabled-color: #ff0000;
      }
      body {
        margin: 0;
        padding: 20px;
        background-color: var(--bg-color);
        color: var(--text-color);
        font-family: "Arial", sans-serif;
      }
      .container {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
        max-width: 1200px;
        margin: 0 auto;
      }
      .visualization {
        background: #2a2a2a;
        padding: 20px;
        border-radius: 10px;
      }
      .visualization h2,
      .stats h2,
      .parameter-controls h3 {
        margin-top: 0;
      }
      canvas {
        width: 100%;
        height: 400px;
        background: #333;
        border-radius: 5px;
      }
      .controls {
        display: flex;
        gap: 10px;
        margin-top: 10px;
      }
      button,
      input[type="number"] {
        background: #4caf50;
        color: white;
        border: none;
        padding: 10px;
        border-radius: 5px;
        cursor: pointer;
        transition: background 0.3s;
      }
      button:hover {
        background: #45a049;
      }
      .stats {
        background: #2a2a2a;
        padding: 20px;
        border-radius: 10px;
      }
      #stats-display {
        font-family: monospace;
        white-space: pre;
      }
      .mutation-controls,
      .parameter-controls {
        display: flex;
        flex-direction: column;
        gap: 10px;
      }
      .mutation-controls label,
      .parameter-controls label {
        display: flex;
        justify-content: space-between;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="visualization">
        <h2>Network Visualization</h2>
        <canvas id="networkCanvas"></canvas>
        <div class="controls">
          <button onclick="startEvolution()">Start Evolution</button>
          <button onclick="pauseEvolution()">Pause</button>
          <button onclick="resetEvolution()">Reset</button>
        </div>
      </div>
      <div class="visualization">
        <h2>Population Fitness</h2>
        <canvas id="populationCanvas"></canvas>
      </div>
      <div class="stats">
        <h2>Statistics</h2>
        <div id="stats-display"></div>
      </div>
      <div class="visualization">
        <div class="parameter-controls">
          <h3>Simulation Parameters</h3>
          <label>
            Population Size:
            <input
              id="populationSize"
              type="number"
              min="10"
              max="200"
              value="50"
            />
          </label>
          <label>
            Target Solution Fitness:
            <input
              id="solutionFitness"
              type="number"
              step="0.01"
              min="0"
              max="1"
              value="0.95"
            />
          </label>
        </div>
        <div class="mutation-controls">
          <h3>Mutation Rates</h3>
          <label
            >Weight Mutation Rate:
            <input
              id="weightMutationRate"
              type="number"
              step="0.01"
              min="0"
              max="1"
              value="0.8"
            />
          </label>
          <label
            >Node Mutation Rate:
            <input
              id="nodeMutationRate"
              type="number"
              step="0.01"
              min="0"
              max="1"
              value="0.3"
            />
          </label>
          <label
            >Connection Mutation Rate:
            <input
              id="connectionMutationRate"
              type="number"
              step="0.01"
              min="0"
              max="1"
              value="0.6"
            />
          </label>
        </div>
      </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.7.0/chart.min.js"></script>
    <script>
      const networkCanvas = document.getElementById("networkCanvas");
      const networkCtx = networkCanvas.getContext("2d");
      const populationCanvas = document.getElementById("populationCanvas");
      const populationCtx = populationCanvas.getContext("2d");
      let neat;
      let isEvolutionRunning = false;
      let evolutionInterval;
      let fitnessChart;

      function initializeNEAT() {
        const populationSize = parseInt(
          document.getElementById("populationSize").value,
          10
        );
        neat = new NEAT(populationSize, 2, 1);
        neat.bestGenome = neat.population[0].clone();
      }

      function drawNetwork(genome) {
        networkCtx.clearRect(0, 0, networkCanvas.width, networkCanvas.height);

        const layerSpacing = networkCanvas.width / 4;
        const inputY = networkCanvas.height / 3;
        const hiddenY = networkCanvas.height / 2;
        const outputY = (networkCanvas.height * 2) / 3;

        genome.nodes.forEach((node) => {
          if (node.type === "input") {
            node.x = layerSpacing;
            node.y = inputY + node.id * 50;
          } else if (node.type === "hidden") {
            node.x = 2 * layerSpacing;
            node.y = hiddenY + (node.id - 2) * 50;
          } else {
            node.x = 3 * layerSpacing;
            node.y = outputY;
          }
        });

        genome.connections.forEach((conn) => {
          networkCtx.beginPath();
          networkCtx.moveTo(conn.fromNode.x, conn.fromNode.y);
          networkCtx.lineTo(conn.toNode.x, conn.toNode.y);
          networkCtx.strokeStyle = conn.enabled
            ? "rgba(33, 150, 243, 0.6)"
            : "rgba(255, 0, 0, 0.3)";
          networkCtx.lineWidth = Math.abs(conn.weight) * 4;
          networkCtx.stroke();
        });

        genome.nodes.forEach((node) => {
          networkCtx.beginPath();
          networkCtx.arc(node.x, node.y, 10, 0, Math.PI * 2);
          networkCtx.fillStyle =
            node.type === "input"
              ? "#4CAF50"
              : node.type === "hidden"
              ? "#FFC107"
              : "#F44336";
          networkCtx.fill();
        });
      }

      function initializeChart() {
        fitnessChart = new Chart(populationCtx, {
          type: "line",
          data: {
            labels: [],
            datasets: [
              {
                label: "Best Fitness",
                data: [],
                borderColor: "#4CAF50",
                tension: 0.1,
              },
              {
                label: "Average Fitness",
                data: [],
                borderColor: "#2196F3",
                tension: 0.1,
              },
              ...Array.from({ length: 10 }, (_, i) => ({
                label: `Genome ${i + 1}`,
                data: [],
                borderColor: `hsl(${i * 36}, 100%, 50%)`,
                tension: 0.1,
                hidden: i >= neat.populationSize ? true : false,
              })),
            ],
          },
          options: {
            responsive: true,
            scales: {
              y: { beginAtZero: true, max: 1 },
            },
          },
        });
      }

      function updateChart() {
        const avgFitness =
          neat.population.reduce((sum, genome) => sum + genome.fitness, 0) /
          neat.population.length;

        fitnessChart.data.labels.push(neat.generation);
        fitnessChart.data.datasets[0].data.push(neat.bestGenome.fitness);
        fitnessChart.data.datasets[1].data.push(avgFitness);

        neat.population.slice(0, 10).forEach((genome, index) => {
          fitnessChart.data.datasets[index].data.push(genome.fitness);
        });

        if (fitnessChart.data.labels.length > 50) {
          fitnessChart.data.labels.shift();
          fitnessChart.data.datasets.forEach((dataset) => dataset.data.shift());
        }

        fitnessChart.update();
      }

      function updateStats() {
        const statsDisplay = document.getElementById("stats-display");
        statsDisplay.textContent = `Generation: ${neat.generation}
    Best Fitness: ${neat.bestGenome.fitness.toFixed(4)}
    Population Size: ${neat.population.length}
    Nodes: ${neat.bestGenome.nodes.length}
    Connections: ${neat.bestGenome.connections.length}`;
      }

      function startEvolution() {
        if (!isEvolutionRunning) {
          const solutionFitness = parseFloat(
            document.getElementById("solutionFitness").value
          );
          initializeNEAT();
          isEvolutionRunning = true;
          evolutionInterval = setInterval(() => {
            neat.evolve();
            drawNetwork(neat.bestGenome);
            updateChart();
            updateStats();

            if (neat.bestGenome.fitness >= solutionFitness) {
              pauseEvolution();
              alert("Solution found!");
            }
          }, 100);
        }
      }

      function pauseEvolution() {
        isEvolutionRunning = false;
        clearInterval(evolutionInterval);
      }

      function resetEvolution() {
        pauseEvolution();
        initializeNEAT();
        if (fitnessChart) {
          fitnessChart.data.labels = [];
          fitnessChart.data.datasets.forEach((dataset) => (dataset.data = []));
          fitnessChart.update();
        }
        drawNetwork(neat.population[0]);
        updateStats();
      }

      // Redefinir a largura e altura do canvas
      networkCanvas.width = networkCanvas.clientWidth;
      networkCanvas.height = networkCanvas.clientHeight;
      populationCanvas.width = populationCanvas.clientWidth;
      populationCanvas.height = populationCanvas.clientHeight;

      initializeNEAT();
      initializeChart();
      drawNetwork(neat.population[0]);
      updateStats();
    </script>
  </body>
</html>
